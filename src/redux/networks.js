import {createAction,createActions} from 'redux-actions'
import fetchJSON from '../utils/fetchJSON'

//
// action constants 
// these can't be namespaced behind telly/networks/FETCH_NETWORKS, because some are 
// generated by redux-promise-middleware and won't match that format
// ----------------------------------------------------------------------------
const FETCH_NETWORKS                = 'FETCH_NETWORKS';
const FETCH_NETWORKS_LOADING        = 'FETCH_NETWORKS_LOADING';
const FETCH_NETWORKS_SUCCESS        = 'FETCH_NETWORKS_SUCCESS';
const FETCH_NETWORKS_ERROR          = 'FETCH_NETWORKS_ERROR';

const FETCH_NETWORK_DETAILS         = 'FETCH_NETWORK_DETAILS';
const FETCH_NETWORK_DETAILS_LOADING = 'FETCH_NETWORK_DETAILS_LOADING';
const FETCH_NETWORK_DETAILS_SUCCESS = 'FETCH_NETWORK_DETAILS_SUCCESS';
const FETCH_NETWORK_DETAILS_ERROR   = 'FETCH_NETWORK_DETAILS_ERROR';

const CREATE_NETWORK                = 'CREATE_NETWORK';
const CREATE_NETWORK_LOADING        = 'CREATE_NETWORK_LOADING';
const CREATE_NETWORK_SUCCESS        = 'CREATE_NETWORK_SUCCESS';
const CREATE_NETWORK_ERROR          = 'CREATE_NETWORK_ERROR';

const UPDATE_NETWORK                = 'UPDATE_NETWORK';
const UPDATE_NETWORK_LOADING        = 'UPDATE_NETWORK_LOADING';
const UPDATE_NETWORK_SUCCESS        = 'UPDATE_NETWORK_SUCCESS';
const UPDATE_NETWORK_ERROR          = 'UPDATE_NETWORK_ERROR';

const DELETE_NETWORK                = 'DELETE_NETWORK';
const DELETE_NETWORK_LOADING        = 'DELETE_NETWORK_LOADING';
const DELETE_NETWORK_SUCCESS        = 'DELETE_NETWORK_SUCCESS';
const DELETE_NETWORK_ERROR          = 'DELETE_NETWORK_ERROR';



//
// reducers
// ----------------------------------------------------------------------------
export const networks = (state = {list: [], loading:false}, action) => {

  switch (action.type){
    case FETCH_NETWORKS_LOADING:
      return {
        list: [],
        loading: true
      }
    case FETCH_NETWORKS_SUCCESS:
      return {
        list: action.payload.networks,
        loading: false
      }
    case FETCH_NETWORKS_ERROR:
      return {
        list: [],
        loading: false,
        error: action.error
      }
    case DELETE_NETWORK_SUCCESS:
      return {
        list: state.list.filter(network => {
          return network._id !== action.payload.network._id
        }),
        loading: false
      }  
    default:
      return state
  }
}

export const network = (state={networkDetails:{}, loading:false}, action={}) => {
  switch (action.type){
    case FETCH_NETWORK_DETAILS_LOADING:
      return {
        loading: true
      }
    case FETCH_NETWORK_DETAILS_SUCCESS: 
      return {
        loading: false,
        networkDetails: action.payload.network
      }
    case CREATE_NETWORK:
      return {
        loading: false
      }
      
    case CREATE_NETWORK_SUCCESS:
      return {
        loading: false,
        message: 'Your changes have been saved'
      }
    case UPDATE_NETWORK_SUCCESS:
      return {
        loading: false,
        message: 'Your changes have been saved',
        networkDetails: action.payload.network
      }
    case DELETE_NETWORK_SUCCESS:
      return {
        loading: false,
        message: 'The requested network has been deleted'
      }
      
    case FETCH_NETWORK_DETAILS_ERROR:
    case CREATE_NETWORK_ERROR:
    case UPDATE_NETWORK_ERROR:
      return {
        loading: false,
        error: action.error
      }
    default:
      return state
  }
}


//
// action creators
// ----------------------------------------------------------------------------
export const getNetworks = () => {
  return (dispatch, getState) => {
    dispatch(
      createAction(FETCH_NETWORKS)(
        fetchJSON(`/networks`)
          .then((xhr => xhr), (e => {throw e}))
        )   
    )
  }
}

export const getNetworkDetails = (id) => {
  return (dispatch, getState) => {
    dispatch(
      createAction(FETCH_NETWORK_DETAILS)(
        fetchJSON(`/networks/${id}`)
          .then((xhr => xhr), (e => {throw e}))
        )   
    )
  }
}


